name: Weekend Weekly Brief

on:
  schedule:
    - cron: '30 13 * * 5'   # Friday 19:00 IST
    - cron: '30 0 * * 6'    # Saturday 06:00 IST fallback
  workflow_dispatch:

concurrency:
  group: repo-writes-${{ github.ref }}
  cancel-in-progress: true

jobs:
  brief:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      TZ: Asia/Kolkata
      PYTHONIOENCODING: utf-8

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Configure git
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git config pull.rebase true
          git fetch origin ${{ github.ref_name }}
          git pull --rebase origin ${{ github.ref_name }} || true

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install -r requirements.txt

      # ✅ Write a proper step output via $GITHUB_OUTPUT (no ::set-output)
      - name: Gate: ensure Friday data exists (or allow Sat)
        id: gate
        shell: bash
        run: |
          ok="$(
            python - <<'PY'
import pandas as pd
from zoneinfo import ZoneInfo

try:
    hist = pd.read_csv('data/prices/bhav_hist.csv', parse_dates=['Date'])
    if hist.empty:
        print("false"); raise SystemExit
except Exception:
    print("false"); raise SystemExit

last = pd.to_datetime(hist['Date'].max())
last_dow = int(last.weekday())  # Mon=0 ... Sun=6
today_dow = int(pd.Timestamp.now(tz=ZoneInfo('Asia/Kolkata')).weekday())

# If run Friday -> require last data is Friday
# If run Saturday -> allow last data is Friday
ok = (today_dow == 4 and last_dow == 4) or (today_dow == 5 and last_dow == 4)
print("true" if ok else "false")
PY
          )"
          echo "ok=$ok" >> "$GITHUB_OUTPUT"
          echo "Gate OK? $ok"

      - name: Score + generate brief
        if: steps.gate.outputs.ok == 'true'
        run: |
          python scripts/score_week.py \
            --hist data/prices/bhav_hist.csv \
            --tech data/tech_latest.csv \
            --out out \
            --mode lite
          python scripts/generate_weekly_brief.py \
            --pack out/WEEK_PACK.csv \
            --out out/WEEK_BRIEF.md \
            --rolling false

      - name: Stage & commit
        if: steps.gate.outputs.ok == 'true'
        run: |
          git add out/WEEK_* data/*status.json
          git diff --staged --quiet && echo "No changes" && exit 0 || true
          git commit -m "Weekend Brief: $(date -u +'%Y-%m-%dT%H:%MZ')"

      - name: Rebase + push with retries
        if: steps.gate.outputs.ok == 'true'
        run: |
          set -e
          for i in 1 2 3; do
            git fetch origin ${{ github.ref_name }}
            git pull --rebase --autostash origin ${{ github.ref_name }} || true
            if git push origin HEAD:${{ github.ref_name }}; then
              echo "Push ok (#$i)"; exit 0
            fi
            echo "Push failed, retrying ($i/3)…"; sleep 3
          done
          exit 1

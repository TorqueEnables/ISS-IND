name: Weekend Weekly Brief

on:
  schedule:
    - cron: '30 13 * * 5'   # Friday 19:00 IST
    - cron: '30 0 * * 6'    # Saturday 06:00 IST fallback
  workflow_dispatch:

concurrency:
  group: repo-writes-${{ github.ref }}
  cancel-in-progress: true

jobs:
  brief:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: write
    env:
      TZ: Asia/Kolkata
      PYTHONIOENCODING: utf-8

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Configure git
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git config pull.rebase true
          git fetch origin ${{ github.ref_name }}
          git pull --rebase origin ${{ github.ref_name }} || true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Gate: allow publish if latest trading day is Fri, OR (holiday case) Thu,
      # and today (IST) is Fri or Sat, and the gap <= 3 days.
      - name: Gate (need latest EOD ~ Friday window)
        id: gate
        shell: bash
        run: |
          set -euo pipefail
          read -r ok last_date last_dow today_dow gap <<EOF
          $(python - <<'PY'
import pandas as pd
from datetime import timedelta
try:
    from zoneinfo import ZoneInfo
    tz = ZoneInfo("Asia/Kolkata")
except Exception:
    tz = None

def out(s): print(s, end='')

try:
    hist = pd.read_csv('data/prices/bhav_hist.csv', parse_dates=['Date'])
    if hist.empty: out("false NA NA NA NA"); raise SystemExit
except Exception:
    out("false NA NA NA NA"); raise SystemExit

last = pd.to_datetime(hist['Date'].max())
last_dow = int(last.weekday())                 # Mon=0..Sun=6
now = pd.Timestamp.now(tz=tz) if tz else pd.Timestamp.now()
today_dow = int(now.weekday())
gap_days = int((now.normalize() - last.normalize()).days)

# Accept if (today is Fri/Sat) AND (last day is Fri or Thu) AND (gap <= 3 days)
ok = (today_dow in (4,5)) and (last_dow in (3,4)) and (gap_days <= 3)

out( f"{'true' if ok else 'false'} {last.date()} {last_dow} {today_dow} {gap_days}" )
PY
          )
          echo "ok=$ok" >> "$GITHUB_OUTPUT"
          echo "last_date=$last_date" >> "$GITHUB_OUTPUT"
          echo "last_dow=$last_dow" >> "$GITHUB_OUTPUT"
          echo "today_dow=$today_dow" >> "$GITHUB_OUTPUT"
          echo "gap_days=$gap" >> "$GITHUB_OUTPUT"
          echo "Gate -> ok=$ok last=$last_date (dow=$last_dow) today_dow=$today_dow gap_days=$gap"

      - name: Score (weekly pack)
        if: ${{ steps.gate.outputs.ok == 'true' }}
        run: |
          mkdir -p out
          python scripts/score_week.py \
            --hist data/prices/bhav_hist.csv \
            --tech data/tech_latest.csv \
            --out out \
            --mode lite

      - name: Generate Weekend Brief
        if: ${{ steps.gate.outputs.ok == 'true' }}
        run: |
          mkdir -p out
          python scripts/generate_weekly_brief.py \
            --pack out/WEEK_PACK.csv \
            --out out/WEEK_BRIEF.md \
            --rolling false

      - name: Stage & commit
        if: ${{ steps.gate.outputs.ok == 'true' }}
        run: |
          set -e
          mkdir -p out
          # Robust adds: don't die if globs are empty
          git add -A out || true
          git add data/*status.json 2>/dev/null || true
          git status --porcelain
          git diff --staged --quiet && echo "No changes" && exit 0 || true
          git commit -m "Weekend Brief (IST): $(date +'%Y-%m-%d %H:%M')"

      - name: Rebase + push (with retries)
        if: ${{ steps.gate.outputs.ok == 'true' }}
        run: |
          set -e
          for i in 1 2 3; do
            git fetch origin ${{ github.ref_name }}
            git pull --rebase --autostash origin ${{ github.ref_name }} || true
            if git push origin HEAD:${{ github.ref_name }}; then
              echo "Push ok (#$i)"; exit 0
            fi
            echo "Push failed, retrying ($i/3)â€¦"; sleep 3
          done
          exit 1

      # Optional Telegram notification (skips if secrets not set)
      - name: Notify Telegram (optional)
        if: ${{ steps.gate.outputs.ok == 'true' }}
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          if [ -n "$TG_BOT_TOKEN" ] && [ -n "$TG_CHAT_ID" ]; then
            MSG="ðŸ“£ Weekend Brief posted â€” $(date +'%Y-%m-%d %H:%M IST')%0Aâ€¢ WEEK_PACK.csv and WEEK_BRIEF.md updated"
            curl -s "https://api.telegram.org/bot$TG_BOT_TOKEN/sendMessage" \
              -d "chat_id=$TG_CHAT_ID" \
              -d "text=$MSG" >/dev/null || true
          else
            echo "Telegram secrets not set; skipping notify."
          fi

      - name: Gate result summary
        if: ${{ steps.gate.outputs.ok != 'true' }}
        run: |
          echo "Skipped: Weekend brief gate failed."
          echo "Debug -> last=${{ steps.gate.outputs.last_date }} (dow=${{ steps.gate.outputs.last_dow }}) today_dow=${{ steps.gate.outputs.today_dow }} gap_days=${{ steps.gate.outputs.gap_days }}"

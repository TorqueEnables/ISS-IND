name: Weekend Weekly Brief

on:
  schedule:
    - cron: '30 13 * * 5'   # Friday 19:00 IST
    - cron: '30 0 * * 6'    # Saturday 06:00 IST fallback
  workflow_dispatch:

concurrency:
  group: repo-writes-${{ github.ref }}
  cancel-in-progress: true

jobs:
  brief:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: write
    env:
      TZ: Asia/Kolkata
      PYTHONIOENCODING: utf-8

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Configure git
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git config pull.rebase true
          git fetch origin ${{ github.ref_name }}
          git pull --rebase origin ${{ github.ref_name }} || true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Gate: publish only if latest trading day is Fri (or Thu for Fri holiday),
      # today (IST) is Fri/Sat, and the gap <= 3 days.
      - name: Gate (weekend publish window)
        id: gate
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY' > gate_out.txt
import pandas as pd
try:
    from zoneinfo import ZoneInfo
    tz = ZoneInfo("Asia/Kolkata")
except Exception:
    tz = None

# Defaults if we can't read history
kv = {"ok":"false","last_date":"NA","last_dow":"NA","today_dow":"NA","gap_days":"NA"}

try:
    hist = pd.read_csv('data/prices/bhav_hist.csv', parse_dates=['Date'])
    if not hist.empty:
        last = pd.to_datetime(hist['Date'].max())
        last_dow = int(last.weekday())                     # Mon=0..Sun=6
        now = pd.Timestamp.now(tz=tz) if tz else pd.Timestamp.now()
        today_dow = int(now.weekday())
        gap_days = int((now.normalize() - last.normalize()).days)

        ok = (today_dow in (4,5)) and (last_dow in (3,4)) and (gap_days <= 3)
        kv.update({
            "ok": "true" if ok else "false",
            "last_date": str(last.date()),
            "last_dow": str(last_dow),
            "today_dow": str(today_dow),
            "gap_days": str(gap_days),
        })
except Exception:
    pass

for k,v in kv.items():
    print(f"{k}={v}")
PY
          # publish outputs
          cat gate_out.txt >> "$GITHUB_OUTPUT"
          echo "----- Gate outputs -----"
          cat gate_out.txt

      - name: Score (weekly pack)
        if: steps.gate.outputs.ok == 'true'
        run: |
          mkdir -p out
          python scripts/score_week.py \
            --hist data/prices/bhav_hist.csv \
            --tech data/tech_latest.csv \
            --out out \
            --mode lite

      - name: Generate Weekend Brief
        if: steps.gate.outputs.ok == 'true'
        run: |
          mkdir -p out
          python scripts/generate_weekly_brief.py \
            --pack out/WEEK_PACK.csv \
            --out out/WEEK_BRIEF.md \
            --rolling false

      - name: Stage & commit
        if: steps.gate.outputs.ok == 'true'
        run: |
          set -e
          mkdir -p out
          git add -A out || true
          git add data/*status.json 2>/dev/null || true
          git status --porcelain
          git diff --staged --quiet && echo "No changes" && exit 0 || true
          git commit -m "Weekend Brief (IST): $(date +'%Y-%m-%d %H:%M')"

      - name: Rebase + push (with retries)
        if: steps.gate.outputs.ok == 'true'
        run: |
          set -e
          for i in 1 2 3; do
            git fetch origin ${{ github.ref_name }}
            git pull --rebase --autostash origin ${{ github.ref_name }} || true
            if git push origin HEAD:${{ github.ref_name }}; then
              echo "Push ok (#$i)"; exit 0
            fi
            echo "Push failed, retrying ($i/3)…"; sleep 3
          done
          exit 1

      # Optional Telegram notification
      - name: Notify Telegram (optional)
        if: steps.gate.outputs.ok == 'true'
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          if [ -n "$TG_BOT_TOKEN" ] && [ -n "$TG_CHAT_ID" ]; then
            MSG="Weekend Brief posted — $(date +'%Y-%m-%d %H:%M IST')%0A• WEEK_PACK.csv and WEEK_BRIEF.md updated"
            curl -s "https://api.telegram.org/bot$TG_BOT_TOKEN/sendMessage" \
              -d "chat_id=$TG_CHAT_ID" \
              -d "text=$MSG" >/dev/null || true
          else
            echo "Telegram secrets not set; skipping notify."
          fi

      - name: Gate result summary
        if: steps.gate.outputs.ok != 'true'
        run: |
          echo "Skipped: gate=false. Details:"
          echo "last_date=${{ steps.gate.outputs.last_date }} last_dow=${{ steps.gate.outputs.last_dow }} today_dow=${{ steps.gate.outputs.today_dow }} gap_days=${{ steps.gate.outputs.gap_days }}"

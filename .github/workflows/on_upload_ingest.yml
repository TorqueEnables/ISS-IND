name: Process & Score on Upload

on:
  push:
    branches: [ "main" ]
    paths:
      - 'data/prices/*.csv'
      - 'data/*Bulk*.csv'
      - 'data/*Block*.csv'
      - 'data/*Insider*.csv'
      # exclusions must come AFTER positives (use !)
      - '!out/**'
      - '!data/*status.json'
  workflow_dispatch:

concurrency:
  group: process-on-upload
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      TZ: Asia/Kolkata
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: pip install -r requirements.txt

      - name: Process EOD
        run: |
          python scripts/process_eod.py \
            --in data/prices \
            --out data \
            --asof auto

      - name: Write bhav_latest.csv from bhav_hist.csv
        run: |
          python - <<'PY'
          import pandas as pd
          from datetime import datetime
          hist = pd.read_csv('data/prices/bhav_hist.csv', parse_dates=['Date'])
          if hist.empty:
              raise SystemExit("bhav_hist.csv is empty; cannot write bhav_latest.csv")

          last = hist['Date'].max()
          snap = hist[hist['Date'] == last].copy()

          # --- Stable, normalized schema for V1/V2 ---
          # If your V1 expects the old cm*bhav headers, see the alternative mapping below.
          cols = ['Date','Symbol','Series','Open','High','Low','Close','PrevClose','Volume','Turnover']
          missing = [c for c in cols if c not in snap.columns]
          if missing:
              raise SystemExit(f"Missing columns in bhav_hist.csv: {missing}")

          out = snap[cols].sort_values(['Symbol','Series'])
          out.to_csv('data/prices/bhav_latest.csv', index=False)

          print(f"Wrote data/prices/bhav_latest.csv for {last.date()} with {len(out)} rows.")
          PY

      - name: Assert bhav_latest.csv matches hist max date
        run: |
          python - <<'PY'
          import pandas as pd, sys
          hist = pd.read_csv('data/prices/bhav_hist.csv', parse_dates=['Date'])
          latest = pd.read_csv('data/prices/bhav_latest.csv', parse_dates=['Date'], dayfirst=False)
          d_hist = hist['Date'].max().date()
          d_latest = latest['Date'].max().date() if 'Date' in latest.columns else None
          if d_latest != d_hist:
              sys.exit(f"bhav_latest.csv date {d_latest} != hist max {d_hist}")
          print(f"OK: bhav_latest.csv is current ({d_hist})")
          PY

      - name: Score weekly pack (Lite)
        run: |
          python scripts/score_week.py \
            --hist data/prices/bhav_hist.csv \
            --tech data/tech_latest.csv \
            --out out \
            --mode lite

      - name: Rolling brief (optional)
        run: |
          python scripts/generate_weekly_brief.py \
            --pack out/WEEK_PACK.csv \
            --out out/WEEK_BRIEF.md \
            --rolling true

      - name: Commit outputs
        run: |
          git config user.email "actions@github.com"
          git config user.name "github-actions[bot]"
          git add data/prices/bhav_hist.csv data/tech_latest.csv data/highlow_52w.csv
          git add data/prices/bhav_latest.csv
          git add data/*status.json out/*
          git commit -m "Auto: process & score on upload $GITHUB_SHA" || echo "Nothing to commit"
          git push


      # Optional Telegram ping (set repo secrets TG_BOT_TOKEN, TG_CHAT_ID)
      - name: Notify Telegram (optional)
        if: always()
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          if [ -n "$TG_BOT_TOKEN" ] && [ -n "$TG_CHAT_ID" ]; then
            MSG="✅ StakeLens updated: $(date +'%Y-%m-%d %H:%M IST')%0A• WEEK_PACK.csv refreshed%0A• Brief: (see repo /out/)"
            curl -s "https://api.telegram.org/bot$TG_BOT_TOKEN/sendMessage" \
              -d "chat_id=$TG_CHAT_ID" -d "text=$MSG" -d "parse_mode=HTML" >/dev/null || true
          fi
